
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </title>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <h1>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </h1>
    <p>ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼: <span id="displayUsername"></span></p>

    <h2>å…¥ã‚ŠãŸã„éƒ¨å±‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</h2>
    <button onclick="joinRoom('room1')">é›‘è«‡éƒ¨å±‹</button>
    <button onclick="joinRoom('room2')">é›‘è«‡éƒ¨å±‹2</button>

    <h3 id="roomTitle"></h3>

    <div id="chat"></div>

    <input type="text" id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
    <button onclick="sendMessage()">é€ä¿¡</button>
    <br><br>

    <input type="file" id="fileInput" />
    <button onclick="uploadFile()">ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡</button>

    <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ï¼ˆDMï¼‰</h3>
    <ul id="userList"></ul>

    <script>
        const socket = io();
        let currentRoom = "";
        const username = localStorage.getItem("username") || "Guest";
        document.getElementById("displayUsername").textContent = username;

        function joinRoom(room) {
            currentRoom = room;
            document.getElementById("roomTitle").textContent = `ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ : ${room}`;
            document.getElementById("chat").innerHTML = "";
            socket.emit("joinRoom", { room, username });
        }

        function sendMessage() {
            const text = document.getElementById("messageInput").value;
            fetch("/send-message", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: text, username, room: currentRoom })
            });
            document.getElementById("messageInput").value = "";
        }

        function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            if (!file) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");

            const formData = new FormData();
            formData.append("file", file);
            formData.append("username", username);
            formData.append("room", currentRoom);

            fetch("/upload", {
                method: "POST",
                body: formData
            });
        }

        socket.on("message", (data) => {
            const div = document.createElement("div");
            if (data.text) {
                div.innerHTML = `<strong>${data.user}:</strong> ${data.text}`;
            } else if (data.file) {
                div.innerHTML = `<strong>${data.user}:</strong> <a href="${data.file}" target="_blank">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã‚‹</a>`;
            }
            document.getElementById("chat").appendChild(div);
        });

        socket.on("messageHistory", (messages) => {
            messages.forEach(data => socket.emit("message", data));
        });

        socket.on("userList", (users) => {
            const userList = document.getElementById("userList");
            userList.innerHTML = "";
            users.forEach(user => {
                const li = document.createElement("li");
                li.textContent = user;
                userList.appendChild(li);
            });
        });

        socket.on("updatePinnedMessage", ({ message }) => {
            const pinned = document.getElementById("pinned");
            if (pinned) {
                pinned.textContent = `ğŸ“Œ ãƒ”ãƒ³æ­¢ã‚: ${message}`;
            } else {
                const p = document.createElement("p");
                p.id = "pinned";
                p.textContent = `ğŸ“Œ ãƒ”ãƒ³æ­¢ã‚: ${message}`;
                document.body.insertBefore(p, document.getElementById("chat"));
            }
        });
    </script>
</body>
</html>
